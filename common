# 파일 경로: utils/common.py
import os
import sys
import yaml
from ctypes import *
from contextlib import contextmanager
from config import settings

# --- C 레벨 에러 로그 차단 (ALSA) ---
ERROR_HANDLER_FUNC = CFUNCTYPE(None, c_char_p, c_int, c_char_p, c_int, c_char_p)
def py_error_handler(filename, line, function, err, fmt): pass
c_error_handler = ERROR_HANDLER_FUNC(py_error_handler)

@contextmanager
def ignore_stderr():
    try:
        devnull = os.open(os.devnull, os.O_WRONLY)
        old_stderr = os.dup(2)
        sys.stderr.flush()
        os.dup2(devnull, 2)
        yield
    exceptException:
        yield
    finally:
        try:
            os.dup2(old_stderr, 2)
            os.close(devnull)
            os.close(old_stderr)
        except: pass

@contextmanager
def no_alsa_error():
    try:
        asound = cdll.LoadLibrary('libasound.so')
        asound.snd_lib_error_set_handler(c_error_handler)
        yield
        asound.snd_lib_error_set_handler(None)
    except:
        yield

# --- 언어 감지 ---
def detect_language(text):
    if any("\uAC00" <= c <= "\uD7A3" for c in text): return 'ko'
    if any("\u3040" <= c <= "\u30FF" for c in text): return 'ja'
    return 'en'

# --- YAML 파일 로드 ---
def load_yaml(file_path):
    if not os.path.exists(file_path):
        return {}
    try:
        with open(file_path, 'r', encoding='utf-8') as f:
            return yaml.safe_load(f)
    except Exception as e:
        print(f"[오류] 파일 로드 실패 ({file_path}): {e}")
        return {}

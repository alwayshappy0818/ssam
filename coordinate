import cv2
import json
import numpy as np
import os

# --- ì„¤ì • ---
# âš ï¸ ì•„ë˜ ë‘ ì¤„ì„ ìì‹ ì˜ í™˜ê²½ì— ë§ê²Œ ìˆ˜ì •í•˜ì„¸ìš”.
ANNOTATION_FILE = 'D:/motor.coco/train/_annotations.coco.json'
IMAGE_DIR = 'D:/motor.coco/train'

# --- COCO JSON íŒŒì¼ ë¡œë“œ ---
try:
    with open(ANNOTATION_FILE, 'r') as f:
        coco_data = json.load(f)
except FileNotFoundError:
    print(f"ì˜¤ë¥˜: '{ANNOTATION_FILE}' íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
    print("ìŠ¤í¬ë¦½íŠ¸ íŒŒì¼ì´ train, valid í´ë”ì™€ ê°™ì€ ìœ„ì¹˜ì— ìˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.")
    exit()

# ì¹´í…Œê³ ë¦¬/ì´ë¯¸ì§€ ì •ë³´ ë¡œë“œ
categories = {cat['id']: cat['name'] for cat in coco_data['categories']}
images_info = {img['id']: img for img in coco_data['images']}
annotations_by_image_id = {}
for ann in coco_data['annotations']:
    img_id = ann['image_id']
    if img_id not in annotations_by_image_id:
        annotations_by_image_id[img_id] = []
    annotations_by_image_id[img_id].append(ann)

# --- í•µì‹¬ ê¸°ëŠ¥ í•¨ìˆ˜ (ì´ì „ê³¼ ë™ì¼) ---
def get_label_at_coordinate(image_id, x, y):
    if image_id not in annotations_by_image_id:
        return "Background"

    annotations = annotations_by_image_id[image_id]
    point = (x, y)

    for ann in annotations:
        segmentation = ann['segmentation'][0]
        contour = np.array(segmentation).reshape((-1, 1, 2)).astype(np.int32)
        distance = cv2.pointPolygonTest(contour, point, False)
        if distance >= 0:
            category_id = ann['category_id']
            return categories[category_id]
            
    return "Background"

# --- ğŸ–±ï¸ ìƒí˜¸ì‘ìš©ì„ ìœ„í•œ ì¶”ê°€ ì½”ë“œ ---

# âš ï¸ í…ŒìŠ¤íŠ¸í•˜ê³  ì‹¶ì€ ì´ë¯¸ì§€ íŒŒì¼ëª…ì„ ì—¬ê¸°ì— ì…ë ¥í•˜ì„¸ìš”.
TARGET_IMAGE_FILENAME = '-2025-06-26-7-_png.rf.4fdedba67f54def9fc7a77b52fd7e2b1.jpg' # ë³¸ì¸ì˜ ì‹¤ì œ íŒŒì¼ëª…ìœ¼ë¡œ ë³€ê²½!

# íŒŒì¼ëª…ìœ¼ë¡œ ì´ë¯¸ì§€ ì •ë³´ ì°¾ê¸°
target_image_info = None
for img in images_info.values():
    if img['file_name'] == TARGET_IMAGE_FILENAME:
        target_image_info = img
        break

if not target_image_info:
    print(f"ì˜¤ë¥˜: '{TARGET_IMAGE_FILENAME}' ì´ë¯¸ì§€ ì •ë³´ë¥¼ ì–´ë…¸í…Œì´ì…˜ íŒŒì¼ì—ì„œ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
    exit()

# ì´ë¯¸ì§€ ë¶ˆëŸ¬ì˜¤ê¸°
image_path = os.path.join(IMAGE_DIR, target_image_info['file_name'])
image = cv2.imread(image_path)
if image is None:
    print(f"ì˜¤ë¥˜: '{image_path}' ì´ë¯¸ì§€ íŒŒì¼ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
    exit()

# ë§ˆìš°ìŠ¤ í´ë¦­ ì´ë²¤íŠ¸ë¥¼ ì²˜ë¦¬í•  í•¨ìˆ˜
def mouse_callback(event, x, y, flags, param):
    if event == cv2.EVENT_LBUTTONDOWN: # ë§ˆìš°ìŠ¤ ì™¼ìª½ ë²„íŠ¼ í´ë¦­ ì‹œ
        label = get_label_at_coordinate(target_image_info['id'], x, y)
        print(f"ì¢Œí‘œ ({x}, {y})ì˜ ë¼ë²¨: {label}")
        # í´ë¦­í•œ ìœ„ì¹˜ì— ì´ˆë¡ìƒ‰ ì› ê·¸ë¦¬ê¸°
        cv2.circle(image, (x, y), 5, (0, 255, 0), -1)
        cv2.imshow("Image", image)

# --- ì‹¤í–‰ ---
print(f"'{TARGET_IMAGE_FILENAME}' ì´ë¯¸ì§€ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.")
print("ì´ë¯¸ì§€ ìœ„ë¥¼ í´ë¦­í•˜ì—¬ í•´ë‹¹ ìœ„ì¹˜ì˜ ë¼ë²¨ì„ í™•ì¸í•˜ì„¸ìš”.")
print("ì¢…ë£Œí•˜ë ¤ë©´ 'q' í‚¤ë¥¼ ëˆ„ë¥´ì„¸ìš”.")

cv2.namedWindow('Image')
cv2.setMouseCallback('Image', mouse_callback)
cv2.imshow('Image', image)
cv2.waitKey(0)
cv2.destroyAllWindows()

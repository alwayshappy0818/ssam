import json, subprocess, platform, requests, pyautogui, os, asyncio
from datetime import datetime
import edge_tts
import pygame
from openai import OpenAI

# --- 1. API ë° ìŒì„± ì—”ì§„ ì„¤ì • ---
try:
    # OpenRouterì—ì„œ ë°œê¸‰ë°›ì€ API í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”.
    # ì´ í‚¤ëŠ” DeepSeek ìì²´ì˜ í‚¤ê°€ ì•„ë‹ˆë¼ OpenRouterì—ì„œ ë°œê¸‰ë°›ì€ í‚¤ì—¬ì•¼ í•©ë‹ˆë‹¤.
    DEEPSEEK_API_KEY = "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"

    # OpenAI ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ OpenRouter ì„œë²„ë¥¼ ë°”ë¼ë³´ê²Œ ì„¤ì •
    client = OpenAI(
        api_key=DEEPSEEK_API_KEY,
        # *** ì¤‘ìš”: DeepSeek ëŒ€ì‹  OpenRouterì˜ API ê¸°ë³¸ URLë¡œ ë³€ê²½ ***
        base_url="https://openrouter.ai/api/v1"
    )
    
    # ì‚¬ìš©í•  DeepSeek ëª¨ë¸ ì„¤ì • (OpenRouterì—ì„œ ì œê³µí•˜ëŠ” ì •í™•í•œ ëª¨ë¸ ì´ë¦„ ì‚¬ìš©)
    # OpenRouter ì›¹ì‚¬ì´íŠ¸ì—ì„œ í™•ì¸í•˜ì‹  ëª¨ë¸ëª…ì„ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤.
    DEEPSEEK_MODEL = "deepseek/deepseek-chat-v3-0324:free" 
    
    # edge-tts ìŒì„± ì„¤ì •
    VOICE = "ko-KR-SunHiNeural"
    RATE = "+20%"
    pygame.mixer.init()

except Exception as e:
    print(f"ì—”ì§„ ì´ˆê¸°í™” ì‹¤íŒ¨: {e}\nAPI í‚¤ ë˜ëŠ” ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì¹˜ë¥¼ í™•ì¸í•˜ì„¸ìš”.")
    exit()

# --- 2. ì„¤ì • íŒŒì¼ ë¡œë“œ ---
try:
    script_dir = os.path.dirname(os.path.abspath(__file__))
    json_path = os.path.join(script_dir, 'commands.json')
    with open(json_path, encoding="utf-8") as f:
        full_config = json.load(f)
    COMMANDS = {k: v for k, v in full_config.items() if not k.startswith("##")}
except FileNotFoundError:
    print(f"ì˜¤ë¥˜: '{json_path}' ì—ì„œ commands.jsonì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
    exit()

# --- 3. í•µì‹¬ ê¸°ëŠ¥ í•¨ìˆ˜ ---
def speak(text):
    print(f"ğŸ”Š ìë¹„ìŠ¤: {text}")
    try: asyncio.run(_speak_async(text))
    except Exception as e: print(f"ìŒì„± ì¶œë ¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {e}")

async def _speak_async(text):
    output_file = "response.mp3"
    try:
        communicate = edge_tts.Communicate(text, VOICE, rate=RATE)
        await communicate.save(output_file)
        pygame.mixer.music.load(output_file)
        pygame.mixer.music.play()
        while pygame.mixer.music.get_busy(): pygame.time.Clock().tick(10)
        pygame.mixer.music.unload(); await asyncio.sleep(0.1); os.remove(output_file)
    except Exception as e: print(f"ë¹„ë™ê¸° ìŒì„± ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜: {e}")

def ask_deepseek(prompt):
    """DeepSeek APIì— í”„ë¡¬í”„íŠ¸ë¥¼ ë³´ë‚´ê³  ì‘ë‹µì„ ë°›ëŠ” í•¨ìˆ˜"""
    try:
        chat_completion = client.chat.completions.create(
            model=DEEPSEEK_MODEL, # ë³€ê²½ëœ ëª¨ë¸ëª… ì‚¬ìš©
            messages=[{"role": "user", "content": prompt}]
        )
        return chat_completion.choices[0].message.content.strip().strip("'\".,")
    except Exception as e:
        print(f"ì˜¤ë¥˜: DeepSeek APIì™€ í†µì‹  ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ({e})")
        return "ì£„ì†¡í•©ë‹ˆë‹¤, ì§€ê¸ˆì€ ë‹µë³€í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."

# (get_current_time, get_weather_forecast, get_response_text, execute í•¨ìˆ˜ëŠ” ì´ì „ê³¼ ë™ì¼)
def get_current_time():
    now = datetime.now(); am_pm = "ì˜¤í›„" if now.hour >= 12 else "ì˜¤ì „"; hour = now.hour - 12 if now.hour > 12 else (12 if now.hour == 0 else now.hour)
    return f"í˜„ì¬ ì‹œê°„ì€ {am_pm} {hour}ì‹œ {now.minute}ë¶„ì…ë‹ˆë‹¤."

def get_weather_forecast():
    try:
        lat, lon = 36.7836, 127.0000; url = f"https://api.open-meteo.com/v1/forecast?latitude={lat}&longitude={lon}&current=temperature_2m,wind_speed_10m"
        response = requests.get(url, timeout=10); response.raise_for_status(); data = response.json()
        temp = data['current']['temperature_2m']; wind_speed_kmh = round(data['current']['wind_speed_10m'] * 3.6, 1)
        return f"í˜„ì¬ ì•„ì‚°ì‹œì˜ ê¸°ì˜¨ì€ {temp}ë„, í’ì†ì€ ì‹œì† {wind_speed_kmh} í‚¬ë¡œë¯¸í„°ì…ë‹ˆë‹¤."
    except: return "ë‚ ì”¨ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."

def get_response_text(command_info):
    target = command_info.get('target_name', ''); action_type = command_info.get('action_type', '')
    def has_batchim(word):
        if not word: return False
        last_char = word[-1]
        if 'ê°€' <= last_char <= 'í£': return (ord(last_char) - ord('ê°€')) % 28 > 0
        return False
    target_eul_reul = target + 'ì„' if has_batchim(target) else target + 'ë¥¼'
    if action_type == 'execute': return f"ì•Œê² ìŠµë‹ˆë‹¤. {target_eul_reul} ì‹¤í–‰í•˜ê² ìŠµë‹ˆë‹¤."
    elif action_type == 'terminate': return f"ë„¤. {target_eul_reul} ì¢…ë£Œí•˜ê² ìŠµë‹ˆë‹¤."
    elif action_type == 'empty': return f"{target_eul_reul} ë¹„ìš°ê² ìŠµë‹ˆë‹¤."
    elif action_type == 'special' and target == 'ìŠ¤í¬ë¦°ìƒ·': return "ìŠ¤í¬ë¦°ìƒ·ì„ ì‹¤í–‰í•©ë‹ˆë‹¤."
    return f"{target} ëª…ë ¹ì„ ì‹¤í–‰í•©ë‹ˆë‹¤."

def execute(action_key):
    command_info = COMMANDS.get(action_key, {}); cmd = command_info.get(platform.system().lower()); action_type = command_info.get("action_type")
    if cmd or action_type == 'special':
        try:
            if action_type == 'execute': subprocess.Popen(cmd, shell=True)
            else: subprocess.run(cmd, shell=True, check=True, capture_output=True, text=True)
            return get_response_text(command_info)
        except Exception as e:
            print(f"'{action_key}' ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {e}")
            return f"{command_info.get('target_name', action_key)} ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."
    return "ì‹¤í–‰í•  ëª…ë ¹ì–´ê°€ ì—†ìŠµë‹ˆë‹¤."

# --- 4. ë©”ì¸ ë£¨í”„ ---
speak("ë”¥ì‹œí¬ ê¸°ë°˜ ìë¹„ìŠ¤ ì…ë‹ˆë‹¤ ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?")
while True:
    text = input("âŒ¨ï¸ ëª…ë ¹ì„ ì…ë ¥í•˜ì„¸ìš”: ")
    if not text.strip(): continue
    command_raw = text.replace("ìë¹„ìŠ¤", "").strip() if "ìë¹„ìŠ¤" in text else text.strip()

    if command_raw.lower() in ['ì¢…ë£Œ', 'exit', 'quit']:
        speak("ìë¹„ìŠ¤ë¥¼ ì¢…ë£Œí•©ë‹ˆë‹¤.")
        break
    
    print(f"ğŸ’¬ ì¸ì‹ëœ ëª…ë ¹: {command_raw}")

    # --- ëª¨ë“  íŒë‹¨ì„ DeepSeekì—ê²Œ ë§¡ê¹ë‹ˆë‹¤. ---
    final_command_key = None
    available_functions = list(COMMANDS.keys())
    function_descriptions = []
    for key, info in COMMANDS.items():
        description = f"- '{key}' (ê´€ë ¨ í‘œí˜„: {', '.join(info.get('aliases', []))})"
        function_descriptions.append(description)
    intent_prompt = (f"ë‹¹ì‹ ì€ ì‚¬ìš©ìì˜ ìì—°ì–´ ëª…ë ¹ì—ì„œ í•µì‹¬ ì˜ë„ë¥¼ íŒŒì•…í•˜ëŠ” AI ë‘ë‡Œì…ë‹ˆë‹¤. ë‹¤ìŒ 'ê¸°ëŠ¥ ì„¤ëª…'ì„ ì°¸ê³ í•˜ì—¬, ì£¼ì–´ì§„ 'ì‚¬ìš©ì ëª…ë ¹'ê³¼ ê°€ì¥ ì¼ì¹˜í•˜ëŠ” ê¸°ëŠ¥ì˜ ì´ë¦„(key) 'í•˜ë‚˜'ë§Œ ì •í™•íˆ ì¶œë ¥í•´ì£¼ì„¸ìš”.\n\n## ê¸°ëŠ¥ ì„¤ëª…:\n" + "\n".join(function_descriptions) + f"\n\n## ì§€ì‹œ:\nì í•©í•œ ê¸°ëŠ¥ì´ ìˆë‹¤ë©´ ê·¸ ê¸°ëŠ¥ì˜ ì´ë¦„ë§Œ, ì—†ë‹¤ë©´ 'NULL'ë§Œ ì¶œë ¥í•˜ì„¸ìš”.\n\n## ì‚¬ìš©ì ëª…ë ¹:\n\"{command_raw}\"")
    
    deepseek_suggestion = ask_deepseek(intent_prompt)
    
    if deepseek_suggestion != "NULL" and deepseek_suggestion in available_functions:
        final_command_key = deepseek_suggestion
    
    result = ""
    if final_command_key:
        command_info = COMMANDS.get(final_command_key, {})
        action_type = command_info.get('action_type')
        if action_type == 'fetch_and_report':
            target_name = command_info.get('target_name')
            if target_name == 'í˜„ì¬ ë‚ ì”¨': result = get_weather_forecast()
            elif target_name == 'í˜„ì¬ ì‹œê°„': result = get_current_time()
        elif action_type == 'special':
            result = get_response_text(command_info)
            pyautogui.hotkey('win', 'shift', 's')
        elif action_type == 'empty':
            speak(f"ê²½ê³ , {command_info.get('target_name')}ì„(ë¥¼) ë¹„ìš°ë©´ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì •ë§ ì‹¤í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")
            confirm = input("ì •ë§ ì‹¤í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (y/n): ")
            result = execute(final_command_key) if confirm.lower() == 'y' else "ì‹¤í–‰ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤."
        else:
            result = execute(final_command_key)
    else:
        chat_prompt = f"ë‹¹ì‹ ì€ 'ë”¥ì‹œí¬ ê¸°ë°˜ ìë¹„ìŠ¤'ë¼ëŠ” ì´ë¦„ì„ ê°€ì§„ AI ë¹„ì„œì…ë‹ˆë‹¤. ì‚¬ìš©ìì˜ ë‹¤ìŒ ë§ì— ëŒ€í•´ ìì—°ìŠ¤ëŸ½ê²Œ ëŒ€í™”í•˜ë“¯ ë‹µë³€í•´ì£¼ì„¸ìš”.ê°€ëŠ¥í•œ í•œ ìµœëŒ€í•œ ì§§ê²Œ ë‹µë³€í•©ë‹ˆë‹¤.\n\nì‚¬ìš©ì: \"{command_raw}\"\nìë¹„ìŠ¤:"
        result = ask_deepseek(chat_prompt) or f"'{command_raw}'ì— í•´ë‹¹í•˜ëŠ” ëª…ë ¹ì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤."

    if result:
        speak(result)

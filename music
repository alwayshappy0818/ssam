# 파일 경로: modules/music.py
import os
import subprocess
from config import settings
from utils.state import state
from modules.tts import speak

def scan_music_files():
    if not os.path.exists(settings.MUSIC_DIR):
        print(f"[경고] 음악 폴더가 없습니다: {settings.MUSIC_DIR}")
        return
    
    state.music_list = [f for f in os.listdir(settings.MUSIC_DIR) if f.lower().endswith('.mp3')]
    print(f"[시스템] 음악 파일 {len(state.music_list)}개를 로드했습니다.")

def play_music_by_keyword(keyword):
    target_file = None
    for fname in state.music_list:
        if keyword.replace(" ", "") in fname.replace(" ", ""):
            target_file = fname
            break
    
    if target_file:
        full_path = os.path.join(settings.MUSIC_DIR, target_file)
        print(f"[음악] 재생 시작: {target_file}")
        speak(f"{target_file[:-4]}를 재생합니다.") 
        
        stop_music() # 기존 음악 정지
            
        try:
            state.music_process = subprocess.Popen(
                ["mplayer", "-volume", "100", "-really-quiet", full_path],
                stdout=subprocess.DEVNULL, 
                stderr=subprocess.DEVNULL
            )
        except Exception as e:
            print(f"[오류] 재생 실패: {e}")
            speak("재생에 실패했습니다.")
            
        state.music_mode = False 
    else:
        speak("찾는 음악이 없습니다. 다시 말씀해 주세요.")

def stop_music():
    if state.music_process:
        if state.music_process.poll() is None:
            try: state.music_process.kill()
            except: pass
        state.music_process = None
